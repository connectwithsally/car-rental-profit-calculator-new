<script>
const S_URL = 'https://mfuoltkdoocdpurqytzt.supabase.co';
const S_KEY = 'REDACTED_FOR_SECURITY';
let st = { mode: 'platform' };

window.go = function(n) {
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  document.getElementById('s' + n).classList.add('active');
  window.scrollTo(0,0);
};

window.setMode = function(m) {
  st.mode = m;
  if(m === 'private') {
    document.getElementById('dist-platform').style.display = 'none';
    document.getElementById('dist-private').style.display = 'block';
  }
  window.go(1);
};

window.calc = function() {
  const cars   = Math.max(0, +document.getElementById('in-cars').value || 0);
  const rate   = Math.max(0, +document.getElementById('in-rate').value || 0);
  const days   = Math.min(30, Math.max(0, +document.getElementById('in-days').value || 0));
  const feesP  = Math.max(0, +document.getElementById('in-fees').value || 0);
  const ins    = Math.max(0, +document.getElementById('in-ins').value || 0);
  const maint  = Math.max(0, +document.getElementById('in-maint').value || 0);
  const hours  = Math.max(0, +document.getElementById('in-hours').value || 0);

  // LOCKED LOGIC
  const idleDays = Math.max(0, 30 - days);

  // CORE CALCULATIONS
  const gross = cars * rate * days;

  const platformCut =
    (st.mode === 'platform' || st.mode === 'both')
      ? gross * (feesP / 100)
      : 0;

  const idleLoss = cars * rate * idleDays;
  const fixedCosts = (ins + maint) * cars;
  const adminCost = hours * 4 * 20; // $20/hr fixed baseline

  const silentLeakage =
    platformCut +
    idleLoss +
    fixedCosts +
    adminCost;

  const profit =
    gross -
    platformCut -
    fixedCosts -
    adminCost;

  const hourly =
    hours > 0 ? profit / (hours * 4) : profit;

  const ctrl =
    gross > 0
      ? Math.max(0, Math.round((profit / gross) * 100))
      : 0;

  // OUTPUT
  document.getElementById('out-gross').innerText =
    '$' + Math.round(gross).toLocaleString();

  document.getElementById('out-leak').innerText =
    '-$' + Math.round(silentLeakage).toLocaleString();

  document.getElementById('out-profit').innerText =
    '$' + Math.round(profit).toLocaleString();

  document.getElementById('out-ctrl').innerText =
    ctrl + '%';

  document.getElementById('out-hourly').innerText =
    '$' + hourly.toFixed(2) + '/hr';

  document.getElementById('dynamic-insight').innerText =
    "If you don’t design the system, friction designs it for you — silently.";

  st.res = { gross, profit, hourly };
  window.go(5);
};
</script>
